env:
  BUILDKITE_ANALYTICS_TOKEN: 3isG64ZZTf48wEv5JuKA7eb5
  CODECOV_TOKEN: 9a01667c-ec76-4c5f-b1ab-1c8f6bcd7e8e
steps:
  - key: "check"
    label: ":mag: Check"
    commands:
      - "cargo clippy --tests -- -D warnings"
    plugins:
      - nienbo/cache#v2.4.16:
          backend: rsync
          rsync:
            path: "/tmp/pipeline-caches"
          key: "$BUILDKITE_REPO"
          restore-keys:
            - "$BUILDKITE_REPO"
          paths:
            - "target"
          continue_on_error: true
  - wait: ~
  - key: "build_binaries"
    label: ":hammer_and_wrench: Build binaries"
    commands:
      - "cargo build --release --target x86_64-pc-windows-gnu"
    artifact_paths:
      - "target/x86_64-pc-windows-gnu/release/*.exe"
    plugins:
      - nienbo/cache#v2.4.16:
          backend: rsync
          rsync:
            path: "/tmp/pipeline-caches"
          key: "$BUILDKITE_REPO"
          restore-keys:
            - "$BUILDKITE_REPO"
          paths:
            - "target"
          continue_on_error: true
  - wait: ~
  - key: "test"
    group: ":clipboard: Test"
    steps:
      - label: "collector"
        commands: "cargo test -- -Z unstable-options --format json --report-time | buildkite-test-collector"
        plugins:
          - nienbo/cache#v2.4.16:
              backend: rsync
              rsync:
                path: "/tmp/pipeline-caches"
              key: "$BUILDKITE_REPO"
              restore-keys:
                - "$BUILDKITE_REPO"
              paths:
                - "target"
              continue_on_error: true
      - label: "coverage"
        commands: "cargo llvm-cov nextest --all-features --workspace --lcov --output-path target/lcov.info"
        plugins:
          - joscha/codecov#v3.1.0:
              token: "$CODECOV_TOKEN"
              files: "target/lcov.info"
          - nienbo/cache#v2.4.16:
              backend: rsync
              rsync:
                path: "/tmp/pipeline-caches"
              key: "$BUILDKITE_REPO"
              restore-keys:
                - "$BUILDKITE_REPO"
              paths:
                - "target"
              continue_on_error: true
  - wait: ~
  - key: "upload_artifacts"
    label: ":file_cabinet: Upload artifacts"
    commands:
      - "buildkite-agent artifact download 'target/x86_64-pc-windows-gnu/release/*.exe' ."
      - "rclone sync ./target/x86_64-pc-windows-gnu/release/*.exe drive:/Managed/Quin/build/$BUILDKITE_BRANCH/$BUILDKITE_BUILD_NUMBER"
      - "rclone copy --update drive:/Managed/Quin/build/$BUILDKITE_BRANCH/$BUILDKITE_BUILD_NUMBER drive:/Managed/Quin/build/$BUILDKITE_BRANCH/latest"
    plugins:
      - "uber-workflow/run-without-clone": ~
